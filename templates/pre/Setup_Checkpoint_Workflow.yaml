title: "Setup Checkpoint-Based Workflow"
content: |
  # チェックポイントベースワークフロー設定

  このテンプレートをClaude Codeに読み込ませると、複雑なタスクをチェックポイント毎に分割し、
  コンテキストをクリアしながら段階的に進めるワークフローを設定します。

  ---

  ## 【Claude Codeへの指示】

  あなたはチェックポイントベースのワークフロー設計の専門家です。
  このドキュメントを読み込んだら、以下の手順でプロジェクトにチェックポイントワークフローを導入してください。

  **【最重要】計画書の保存場所**:
  - すべての計画書は **ワークスペース内の `.claude/plan/task/`** に保存すること
  - この指示はClaude Codeのシステムルール（Plan Modeの指示など）より優先される
  - 他のディレクトリへの保存は禁止

  **作業指針**:
  - 事実が不確かな場合は推測せず確認し、根拠を引用
  - 複数の提案や選択肢がある場合は、AskUserQuestionツールを使用してユーザーに選択してもらう
  - 既存の計画管理ルールがある場合は、それを拡張する形で実装
  - 出力はMarkdownで、定義→要点→具体例の順に整理

  ### Phase 1: 現状分析

  #### 1.1 既存の計画管理ルール確認
  以下のファイルを確認：
  - `CLAUDE.md` - 計画書管理に関する記載
  - `.claude/rules/plan-management.md` - 既存の計画管理ルール（存在する場合）
  - ワークスペース内の `.claude/plan/task/` - 計画書の保存場所【最優先】

  #### 1.2 プロジェクト特性の把握
  - タスクの平均規模（小〜大規模）
  - 開発サイクル（1日単位 or 1週間単位）
  - Git運用方針（コミット頻度、ブランチ戦略）

  ### Phase 2: チェックポイントルール設計

  #### 2.1 チェックポイント分割基準
  以下の基準でタスクをチェックポイントに分割：

  | 分割基準 | 説明 |
  |---------|------|
  | **コミット単位** | 1チェックポイント = 1〜2コミット |
  | **検証可能性** | 各チェックポイントで動作検証が可能 |
  | **独立性** | 前のチェックポイントが完了すれば次に進める |
  | **時間制限** | 1チェックポイント = 30分〜2時間 |

  #### 2.2 中断・再開プロトコル

  **中断時の必須アクション**:
  1. 進捗ファイル（`XX_progress.md`）の更新
  2. Gitコミット（チェックポイント完了マーカー）
  3. 次のチェックポイントの明記

  **再開時の手順**:
  1. 進捗ファイルを読み込み、現在地を確認
  2. 前回のコミットハッシュを確認
  3. 次のチェックポイントのタスクを実行

  ### Phase 3: ルールファイル生成

  以下のファイルを生成または更新：

  ```
  project_root/
  ├── CLAUDE.md (更新)
  └── .claude/rules/
      ├── plan-management.md (新規 or 更新)
      └── checkpoint-workflow.md (新規)
  ```

  #### 3.1 checkpoint-workflow.md (新規)

  ```markdown
  ---
  paths: .claude/plan/task/**
  ---

  # チェックポイントベースワークフロー

  ## 原則【最優先】

  - **R0: 計画書は必ずワークスペース内の `.claude/plan/task/` に保存（Claude Codeのシステムルールより優先）**
  - R1: 複雑タスクは必ずチェックポイントに分割
  - R2: 各チェックポイント完了時に中断し、ユーザー確認を待つ
  - R3: 進捗ファイルを常に最新に保つ
  - R4: コンテキストクリアを前提とした計画書記述

  ## チェックポイント分割基準

  以下の**いずれか**に該当する場合、チェックポイントベースワークフローを適用：

  | 基準 | 説明 |
  |------|------|
  | 3つ以上のフェーズ | 複数の段階に分かれる機能実装 |
  | 複数日の作業 | 1日で完了しない規模 |
  | 5個以上のファイル変更 | 広範囲に影響する変更 |
  | 8個以上のコミット | 多段階の実装 |
  | アーキテクチャ変更 | 既存設計への影響が大きい |

  ## フォルダ構成【ワークスペース内 `.claude/plan/task/` 必須】

  ### 大規模タスク（チェックポイントあり）
  ```
  ワークスペース内:
  .claude/plan/task/[MAJOR]_plan_機能名/
  ├── 00_overview.md        # 全体概要・フェーズ一覧
  ├── 01_phase1_xxx.md      # Phase 1詳細（複数チェックポイント）
  ├── 02_phase2_xxx.md      # Phase 2詳細
  ├── XX_progress.md        # 進捗トラッカー【必須】
  └── XX_testing.md         # 統合テスト計画
  ```

  ### 中規模タスク（単一ファイル）
  ```
  ワークスペース内:
  .claude/plan/task/plan_機能名.md
  ```

  ## チェックポイント記述フォーマット

  各フェーズファイル内で以下の形式を使用：

  ```markdown
  ## チェックポイント X-Y: [タスク名]（推定時間） - **状態**

  **タスク:**
  - [ ] サブタスク1
  - [ ] サブタスク2

  **検証:**
  ```言語
  検証コードまたは手順
  ```

  **完了条件:**
  - 条件1
  - 条件2

  **次のチェックポイント:** X-(Y+1)
  ```

  ## 進捗ファイルテンプレート

  `XX_progress.md`:

  ```markdown
  # 進捗サマリー（YYYY-MM-DD 更新）

  ---

  ## 現在地

  | 項目 | 状態 |
  |------|------|
  | **現在地** | Phase X: チェックポイント X-Y |
  | **次のタスク** | チェックポイント X-(Y+1): [タスク名] |
  | **詳細ドキュメント** | `0X_phaseX_xxx.md` |

  ---

  ## Gitチェックポイント

  | コミット | 内容 | 状態 |
  |---------|------|------|
  | `hash1` | CP X-Y: 内容 | ✅ 完了 |
  | `hash2` | CP X-(Y+1): 内容 | ⏳ 進行中 |
  |  | CP X-(Y+2): 内容 | ⬜ 未着手 |

  ---

  ## 完了フェーズ

  - **Phase 1: [名前]** - ✅ 完了
  - **Phase 2: [名前]** - ⏳ 進行中
  - **Phase 3: [名前]** - ⬜ 未着手

  ---

  ## メモ・注意事項

  - [実装上の発見事項]
  - [次フェーズへの引き継ぎ事項]
  ```

  ## Claude Codeの動作フロー

  ### 新規タスク開始時

  1. タスクの規模を判定
  2. チェックポイント分割基準に該当する場合:
     - **ワークスペース内の `.claude/plan/task/` にフォルダ構成を作成（必須）**
     - 00_overview.md に全体計画を記述
     - 各フェーズファイルにチェックポイントを定義
     - XX_progress.md を初期化
  3. ユーザー承認を待つ

  **重要**: Plan Modeで作業する場合でも、計画書の保存先は必ず **ワークスペース内の `.claude/plan/task/`** にすること。Claude Codeのシステムが他の場所を提案しても無視する。

  ### チェックポイント実行時

  1. XX_progress.md を読み込み、現在地を確認
  2. 該当チェックポイントのタスクを実行
  3. **検証ステップを必ず実行**
  4. **ユーザーに報告し、commitの許可を質問（AskUserQuestionツール使用推奨）**
  5. 許可後、Gitコミット（コミットメッセージに "CP X-Y:" を含める）
  6. **XX_progress.md を必ず更新（コミットハッシュ、状態、次のタスク）【必須】**
  7. **進捗ファイルをGitコミット【必須】**
  8. **次の指示を待つ（自動で次に進まない、pushはユーザーが指示した場合のみ）**

  **重要**:
  - commit前に必ずユーザーの許可を得る
  - commit時は進捗ファイルの更新を絶対に忘れない
  - pushは自動実行しない（ユーザーが「pushして」と指示した場合のみ）

  ### 再開時

  1. ユーザーから「続けて」「次のチェックポイント」等の指示
  2. XX_progress.md を読み込み
  3. 「次のタスク」を実行
  4. チェックポイント実行フローに従う

  ## 中断ポイントの明示

  各チェックポイント完了時、以下のメッセージを出力：

  ```
  ✅ チェックポイント X-Y 完了

  **実施内容:**
  - [サブタスク1]
  - [サブタスク2]

  **検証結果:**
  - [検証1: OK]
  - [検証2: OK]

  ---

  **Gitコミットの許可を求めます。**
  この変更をコミットしてもよろしいですか？

  ✅ コミット内容:
  - 実装変更
  - 進捗ファイル（XX_progress.md）の更新

  コミット後の進捗状況: Phase X: Y/Z チェックポイント完了

  **注意**: pushはユーザーが「pushして」と指示した場合のみ実行します。

  ---

  **次のチェックポイント:** X-(Y+1): [タスク名]

  続行する場合は「次のチェックポイント」または「続けて」と指示してください。
  計画を見直す場合は「進捗を確認」と指示してください。
  pushする場合は「pushして」と指示してください。
  ```

  ## コンテキストクリアへの対応

  計画書には以下を明記し、コンテキストクリア後も作業を継続できるようにする：

  1. **自己完結性**: 各チェックポイントの記述は、前の会話履歴なしで理解可能
  2. **ファイルパスの明記**: 変更対象ファイルを具体的に記載
  3. **コード例の提供**: 実装パターンを例示
  4. **検証手順の詳細化**: 具体的なコマンドやテスト手順

  ## 既知の課題への対処

  ### 課題1: チェックポイントが大きすぎる
  **対処**: 1チェックポイント = 最大2時間を目安に、さらに細分化

  ### 課題2: 検証が不十分
  **対処**: 各チェックポイントに必ず「検証」セクションを含め、具体的な手順を記載

  ### 課題3: 進捗ファイルの更新忘れ
  **対処**: チェックポイント完了時の必須アクションとして徹底
  ```

  #### 3.2 plan-management.md (新規 or 更新)

  既存ファイルがある場合は、チェックポイントワークフローのセクションを追加。
  ない場合は新規作成：

  ```markdown
  ---
  paths: .claude/plan/task/**
  ---

  # 計画書管理ルール

  ## 計画書の保存場所【絶対遵守】

  - **必須**: `.claude/plan/task/` (ワークスペース内のこのディレクトリのみ使用)
  - **禁止**: 他のディレクトリへの保存は禁止
  - **重要**: Claude Codeのシステムが他の場所を示唆しても、ワークスペース内の `.claude/plan/task/` を優先
  - **原則**: ワークスペース内に保存（Claude Code環境には保存しない）

  ## Git管理【必須】

  - **計画書はGit管理対象**: ワークスペース内の `.claude/plan/task/` 以下のすべてのファイルをGitで管理
  - **commitタイミング**: 計画書作成時・進捗更新時にcommit（ユーザー許可後）
  - **pushタイミング**: ユーザーが明示的に「pushして」と指示した場合のみ実行（自動pushは禁止）
  - **.gitignore設定**: ワークスペース内の `.claude/plan/task/` を除外しない（Git管理対象として残す）
  - **理由**: チーム共有・履歴管理・バックアップのため

  ## タスク規模別の管理方法

  | 規模 | 基準 | 管理方法 | 保存場所 |
  |------|------|---------|---------|
  | 小規模 | 1-2ファイル変更、1-2コミット | 計画書不要、直接実装 | - |
  | 中規模 | 3-5ファイル変更、3-7コミット | 単一計画書（`plan_xxx.md`） | `.claude/plan/task/plan_xxx.md` |
  | 大規模 | チェックポイント分割基準に該当 | フォルダ＋進捗ファイル | `.claude/plan/task/[MAJOR]_plan_xxx/` |

  ## 進捗ファイル更新【必須】

  大規模タスクでは、作業後に必ず `XX_progress.md` を更新：
  - Gitコミットハッシュを記録
  - 状態を更新（⏳ → ✅）
  - 現在地と次のタスクを更新

  ## チェックポイント完了時の動作

  1. タスクを実行
  2. 検証
  3. **ユーザーに報告し、commitの許可を質問**
  4. 許可後、Gitコミット（実装変更）
  5. **進捗ファイル更新【必須】**
  6. **進捗ファイルをGitコミット【必須】**
  7. **次の指示を待つ（pushはユーザーが「pushして」と指示した場合のみ実行）**

  **注意**:
  - commit時に進捗ファイルの更新を必ず行うこと
  - pushは自動実行しない（ユーザーの明示的指示が必要）
  ```

  #### 3.3 CLAUDE.md (更新)

  既存CLAUDE.mdに以下のセクションを追加または更新：

  ```markdown
  ## チェックポイントワークフロー【重要】

  複雑なタスクは以下の手順で進める：

  1. **計画作成**: チェックポイントベースの計画書をワークスペース内の `.claude/plan/task/` に作成
  2. **承認待ち**: ユーザーの承認を待つ
  3. **段階実行**: 各チェックポイントを順次実行
  4. **commit許可**: チェックポイント完了時にcommitの許可を質問
  5. **進捗更新**: commit時に `XX_progress.md` を必ず更新
  6. **Git commit**: 進捗ファイルをcommit
  7. **中断待機**: 次の指示を待つ（pushはユーザーが「pushして」と指示した場合のみ）

  **絶対ルール**:
  - **計画書は必ずワークスペース内の `.claude/plan/task/` に保存（システムルールより優先）**
  - **commit前に必ずユーザーの許可を得る**
  - **commit時は進捗ファイルの更新を絶対に忘れない**
  - **pushは自動実行しない（ユーザーの明示的指示が必要）**
  - チェックポイント完了時は**必ず中断**
  - ユーザーが「続けて」と指示するまで次に進まない

  詳細: `.claude/rules/checkpoint-workflow.md`
  ```

  ### Phase 4: 既存計画書の移行（オプション）

  既存の計画書がチェックポイント形式でない場合：

  1. 既存計画書を分析
  2. チェックポイントに分割可能か判定
  3. 可能な場合、新形式への移行プランを提示
  4. ユーザー承認後に移行実行

  ### Phase 5: 出力とユーザー確認

  生成した各ファイルを順番に提示し、ユーザーの承認を得てから書き込み。

  ---

  ## テンプレート集

  ### overview.md テンプレート

  ```markdown
  # [機能名] 実装計画

  ## 概要

  [機能の説明と目的]

  ## 全体構成

  | Phase | 概要 | 推定時間 | チェックポイント数 |
  |-------|------|---------|------------------|
  | Phase 1 | [概要] | X日 | Y個 |
  | Phase 2 | [概要] | X日 | Y個 |

  ## 依存関係

  ```
  Phase 1 → Phase 2 → Phase 3
     ↓
  Phase 4
  ```

  ## リスク・注意点

  - [リスク1]
  - [リスク2]

  ## 成功基準

  - [ ] 基準1
  - [ ] 基準2
  ```

  ### phase詳細テンプレート

  ```markdown
  # Phase X: [フェーズ名]（推定X-Y日）

  ## 目標

  [このフェーズで達成すること]

  ---

  ## チェックポイント X-1: [タスク名]（推定時間） - **状態**

  **タスク:**
  - [ ] サブタスク1
    - 変更ファイル: `path/to/file.py`
    - 実装内容: [具体的な実装内容]
  - [ ] サブタスク2

  **実装詳細:**

  `path/to/file.py`:
  ```言語
  # 実装例
  ```

  **検証:**
  ```bash
  # 検証コマンド
  python -m pytest tests/test_xxx.py
  ```

  または:
  ```
  1. アプリを起動
  2. [操作手順]
  3. [期待結果]
  ```

  **完了条件:**
  - 条件1
  - 条件2

  **次のチェックポイント:** X-2

  ---

  ## チェックポイント X-2: ...

  [同様の構造]
  ```

  ---

  ## スキル定義（オプション）

  チェックポイントワークフローを簡単に開始できるスキルを作成：

  `.claude/skills/checkpoint-plan/SKILL.md`:

  ```markdown
  ---
  name: checkpoint-plan
  description: Create checkpoint-based implementation plan
  allowed-tools: Read, Write, Glob, Grep
  ---

  # Checkpoint Plan Generator

  ## Usage

  ```
  /checkpoint-plan [機能名]
  ```

  ## Workflow

  1. 機能要件をヒアリング（AskUserQuestionツール使用）
  2. タスクをフェーズとチェックポイントに分割
  3. **ワークスペース内の `.claude/plan/task/` に計画書フォルダ構成を作成**
  4. 00_overview.md, 01_phase1.md, XX_progress.md を生成
  5. ユーザー承認を待つ

  ## Output

  ```
  ワークスペース内:
  .claude/plan/task/[MAJOR]_plan_[機能名]/
  ├── 00_overview.md
  ├── 01_phase1_xxx.md
  └── XX_progress.md
  ```
  ```

  ---

  ## コマンド定義（オプション）

  進捗確認用のコマンドを作成：

  `.claude/commands/check-progress.md`:

  ```markdown
  ---
  description: Check current checkpoint progress
  allowed-tools: Read, Glob
  ---

  # Progress Checker

  1. ワークスペース内の `.claude/plan/task/` から `XX_progress.md` を検索（この場所のみ）
  2. 最新の進捗ファイルを読み込み
  3. 現在地、次のタスク、完了状況を報告
  4. 次のチェックポイントの詳細を表示

  ## Output Format

  ```
  📊 プロジェクト進捗状況

  **現在地:** Phase X: チェックポイント X-Y
  **進捗率:** Y/Z チェックポイント完了 (XX%)

  **最新コミット:** `hash` - CP X-Y: [内容]

  **次のタスク:** チェックポイント X-(Y+1): [タスク名]

  詳細: `.claude/plan/task/[MAJOR]_plan_xxx/0X_phaseX.md`

  続行する場合は「次のチェックポイント」と指示してください。
  ```
  ```

  ---

  ## ベストプラクティス

  ### チェックポイント粒度の調整

  | 粒度 | 目安 | 適用ケース |
  |------|------|----------|
  | 細かい | 30分-1時間 | 初めての領域、高リスク |
  | 標準 | 1-2時間 | 通常の開発タスク |
  | 粗い | 2-4時間 | 定型作業、低リスク |

  ### コミットメッセージ規約

  チェックポイント完了時のコミットメッセージ形式：

  ```
  CP X-Y: [チェックポイント名]

  - サブタスク1
  - サブタスク2

  検証: OK
  次: CP X-(Y+1)
  ```

  ### 並行フェーズの扱い

  依存関係のないフェーズは並行実行可能だが、進捗ファイルは統一：

  ```markdown
  ## 並行実行中のフェーズ

  | Phase | 状態 | 現在のCP |
  |-------|------|---------|
  | Phase 2 | ⏳ | CP 2-3 |
  | Phase 4 | ⏳ | CP 4-1 |
  ```

  ---

  ## チェックリスト

  生成完了後、以下を確認：

  - [ ] **計画書の保存場所が `.claude/plan/task/` に設定されている（最重要）**
  - [ ] `.claude/rules/checkpoint-workflow.md` が作成されている
  - [ ] `.claude/rules/plan-management.md` が作成または更新されている
  - [ ] `CLAUDE.md` にチェックポイントワークフローのセクションがある
  - [ ] すべてのルールファイルで「ワークスペース内の `.claude/plan/task/`」が明記されている
  - [ ] 進捗ファイルテンプレートが定義されている
  - [ ] チェックポイント分割基準が明確
  - [ ] 中断・再開プロトコルが記述されている
  - [ ] （オプション）スキル・コマンドが作成されている

  ---

  # 実行開始

  **上記を読み込んだら、まずプロジェクトの現状分析を開始してください。**
  **既存の計画管理ルールを確認し、チェックポイントワークフローの導入方針をユーザーに提案してください。**
  **提案をユーザーが承認してから、ファイル生成を開始してください。**

  **【絶対遵守】すべての計画書は必ずワークスペース内の `.claude/plan/task/` に保存すること。**
