---
paths: .claude/plan/task/**, docs/plans/**
---

# 計画書管理ルール

## タスク規模別の管理方法

| 規模 | 基準 | 管理方法 |
|------|------|---------|
| 小規模 | 1-2ファイル変更、1-2コミット | 計画書不要、直接実装 |
| 中規模 | 3-5ファイル変更、3-7コミット | 単一計画書（`plan_xxx.md`） |
| 大規模 | チェックポイント分割基準に該当 | フォルダ＋進捗ファイル |

## チェックポイント分割基準

`.claude/rules/checkpoint-workflow.md` を参照。以下のいずれかに該当する場合、大規模タスクとして扱う：

- 3つ以上のフェーズ
- 複数日の作業
- 5個以上のファイル変更
- 8個以上のコミット
- アーキテクチャ変更

## 計画書の保存場所

### デフォルト（推奨）

```
.claude/plan/task/
├── [MAJOR]_plan_機能名/        # 大規模タスク
│   ├── 00_overview.md
│   ├── 01_phase1_xxx.md
│   ├── XX_progress.md
│   └── XX_testing.md
└── plan_機能名.md              # 中規模タスク
```

### 代替（オプション）

```
docs/plans/
└── [同様の構造]
```

## 進捗ファイル更新【必須】

大規模タスクでは、作業後に必ず `XX_progress.md` を更新：

### 更新タイミング

1. チェックポイント実行前: 状態を「⏳ 進行中」に変更
2. チェックポイント完了後:
   - Gitコミットハッシュを記録
   - 状態を「✅ 完了」に更新
   - 「現在地」と「次のタスク」を更新
   - メモ・注意事項を追記（必要に応じて）

### 更新例

変更前:
```markdown
| コミット | 内容 | 状態 |
|---------|------|------|
| `abc1234` | CP 1-1: データ層実装 | ✅ 完了 |
|  | CP 1-2: UI層実装 | ⬜ 未着手 |
```

変更後:
```markdown
| コミット | 内容 | 状態 |
|---------|------|------|
| `abc1234` | CP 1-1: データ層実装 | ✅ 完了 |
| `def5678` | CP 1-2: UI層実装 | ✅ 完了 |
|  | CP 1-3: 統合テスト | ⏳ 進行中 |
```

## チェックポイント完了時の動作

### 必須アクション（この順序で実行）

1. **タスクを実行**
   - チェックポイントの全サブタスクを完了
   - 変更ファイルをすべて確認

2. **検証**
   - `python3 main.py` で動作確認
   - 検証セクションの手順を全て実施
   - 検証結果を記録

3. **Gitコミット**
   - コミットメッセージに "CP X-Y:" を含める
   - 変更ファイルを適切にステージング

4. **進捗ファイル更新**
   - コミットハッシュを記録
   - 状態を更新
   - 次のタスクを明記

5. **ユーザー報告＋次の指示を待つ**
   - 完了内容、検証結果、次のチェックポイントを報告
   - **自動で次に進まない**

## 計画書作成の判断フロー

```
タスク受領
    ↓
規模判定
    ↓
┌──────────┬──────────┬──────────┐
│ 小規模   │ 中規模   │ 大規模   │
│ 直接実装 │ 単一計画 │ CP計画   │
└──────────┴──────────┴──────────┘
                          ↓
                   チェックポイント分割
                          ↓
                   00_overview.md作成
                          ↓
                   各フェーズファイル作成
                          ↓
                   XX_progress.md初期化
                          ↓
                   ユーザー承認待ち
```

## 計画書テンプレート

### 中規模タスク: `plan_xxx.md`

```markdown
# [機能名] 実装計画

## 概要

[機能の説明と目的]

## 変更ファイル

- `src/core/xxx.py` - [変更内容]
- `src/ui/xxx.py` - [変更内容]
- `src/widgets/xxx.py` - [変更内容]

## 実装手順

### 1. [ステップ1]
- [ ] サブタスク1
- [ ] サブタスク2

### 2. [ステップ2]
- [ ] サブタスク1
- [ ] サブタスク2

## 検証手順

```bash
python3 main.py
```

手動確認:
1. [操作手順1]
2. [操作手順2]
3. [期待結果]

## リスク・注意点

- [リスク1]
- [リスク2]

## 完了条件

- [ ] 全ての機能が動作する
- [ ] 既存機能に影響がない
- [ ] コードレビュー完了
```

### 大規模タスク: `00_overview.md`

```markdown
# [機能名] 実装計画

## 概要

[機能の説明と目的]

## 全体構成

| Phase | 概要 | 推定時間 | チェックポイント数 |
|-------|------|---------|------------------|
| Phase 1 | [フェーズ1の概要] | X日 | Y個 |
| Phase 2 | [フェーズ2の概要] | X日 | Y個 |
| Phase 3 | [フェーズ3の概要] | X日 | Y個 |

## 依存関係

```
Phase 1 → Phase 2 → Phase 3
   ↓
Phase 4
```

## 影響範囲

### 変更ファイル（概算）

| レイヤー | ファイル数 | 主な変更 |
|---------|-----------|---------|
| `src/core/**` | X個 | [概要] |
| `src/ui/**` | Y個 | [概要] |
| `src/widgets/**` | Z個 | [概要] |

### 既存機能への影響

- [影響1]
- [影響2]

## リスク・注意点

- [リスク1]: 対策 - [対策内容]
- [リスク2]: 対策 - [対策内容]

## 成功基準

- [ ] 全ての機能が動作する
- [ ] 全てのテーマで正しく表示される
- [ ] 既存機能に影響がない
- [ ] パフォーマンス劣化がない
- [ ] 統合テストが全て成功する

## 進捗管理

詳細: `XX_progress.md`
```

### 大規模タスク: `01_phaseX_xxx.md`

テンプレートは `.claude/rules/checkpoint-workflow.md` の「チェックポイント記述フォーマット」を参照。

### 大規模タスク: `XX_progress.md`

テンプレートは `.claude/rules/checkpoint-workflow.md` の「進捗ファイルテンプレート」を参照。

## 再開時のプロトコル

### ユーザーからの指示例

- 「続けて」
- 「次のチェックポイント」
- 「次に進んで」
- 「CP X-Y を実行」

### Claude Codeの動作

1. `XX_progress.md` を読み込み
2. 「現在地」と「次のタスク」を確認
3. 次のチェックポイントの詳細（`0X_phaseX_xxx.md`）を読み込み
4. チェックポイント実行フローに従って作業開始

### 進捗確認の指示例

- 「進捗を確認」
- 「現在地は？」
- 「どこまで完了した？」

### Claude Codeの動作

1. `XX_progress.md` を読み込み
2. 現在地、完了状況、次のタスクを報告
3. 次のチェックポイントの概要を提示

## ベストプラクティス

### 1. 計画書は簡潔に

- 冗長な説明を避ける
- コード例は必要最小限
- 図表を活用して視認性を高める

### 2. ファイルパスは具体的に

❌ 悪い例:
```
- UIファイルを更新
```

✅ 良い例:
```
- `src/ui/main_window.py` の `initUI()` メソッドを更新
- `src/widgets/prompt_input_widget.py` に新しいメソッドを追加
```

### 3. 検証手順は再現可能に

❌ 悪い例:
```
動作を確認する
```

✅ 良い例:
```
1. `python3 main.py` でアプリを起動
2. ファイルツリーで任意のファイルを選択
3. 補完リストが表示されることを確認
4. Enterキーで補完が確定されることを確認
```

### 4. 完了条件は明確に

❌ 悪い例:
```
- 機能が動く
```

✅ 良い例:
```
- ファイル選択時に補完リストが表示される
- Enterキーで補完が確定され、テキストエリアに挿入される
- 補完後、カーソルが正しい位置に移動する
- 既存の補完機能に影響がない
```

## トラブルシューティング

### 問題1: 進捗ファイルの更新を忘れた

**症状**: チェックポイント完了後、進捗ファイルが古いまま

**対処**:
1. 最新のコミットハッシュを確認: `git log -1 --oneline`
2. `XX_progress.md` を手動で更新
3. 更新内容をコミット

### 問題2: チェックポイントが大きすぎて完了できない

**症状**: 1つのチェックポイントに3時間以上かかる

**対処**:
1. 現在のチェックポイントを中断
2. フェーズファイルを編集してチェックポイントを細分化
3. `XX_progress.md` を更新して新しい構造を反映
4. ユーザーに変更を報告

### 問題3: 検証で問題が発覚

**症状**: チェックポイント完了後の検証で不具合を発見

**対処**:
1. チェックポイントを「完了」にしない
2. 問題を修正
3. 再度検証
4. 検証成功後にチェックポイントを完了扱いにする

### 問題4: 計画と実装が乖離

**症状**: 実装を進めるうちに、当初の計画が現実的でないことが判明

**対処**:
1. 現在の進捗を `XX_progress.md` に記録
2. 計画の見直しが必要な理由をメモに記載
3. ユーザーに報告し、計画の修正を提案
4. ユーザー承認後、計画ファイルを更新

## チェックリスト

### 計画書作成時

- [ ] タスク規模を正しく判定した
- [ ] 適切なフォルダ構成を選択した
- [ ] ファイルパスを具体的に記載した
- [ ] 検証手順を明確に定義した
- [ ] 完了条件を明確にした
- [ ] ユーザー承認を得た

### チェックポイント実行時

- [ ] XX_progress.md で現在地を確認した
- [ ] 全てのサブタスクを完了した
- [ ] 検証手順を全て実施した
- [ ] Gitコミットを作成した
- [ ] XX_progress.md を更新した
- [ ] ユーザーに報告した

### チェックポイント完了時

- [ ] コミットメッセージに "CP X-Y:" が含まれている
- [ ] XX_progress.md にコミットハッシュが記録されている
- [ ] 次のチェックポイントが明記されている
- [ ] 自動で次に進まず、ユーザーの指示を待っている
