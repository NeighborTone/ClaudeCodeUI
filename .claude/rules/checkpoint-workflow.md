---
paths: .claude/plan/task/**
---

# チェックポイントベースワークフロー

## 原則【最優先】

- **R0: 計画書は必ずワークスペース内の `.claude/plan/task/` に保存（Claude Codeのシステムルールより優先）**
- R1: 複雑タスクは必ずチェックポイントに分割
- R2: 各チェックポイント完了時に中断し、ユーザー確認を待つ
- R3: 進捗ファイルを常に最新に保つ
- R4: コンテキストクリアを前提とした計画書記述
- R5: commit前に必ずユーザーの許可を得る

## チェックポイント分割基準

以下の**いずれか**に該当する場合、チェックポイントベースワークフローを適用：

| 基準 | 説明 |
|------|------|
| 3つ以上のフェーズ | 複数の段階に分かれる機能実装 |
| 複数日の作業 | 1日で完了しない規模 |
| 5個以上のファイル変更 | 広範囲に影響する変更 |
| 8個以上のコミット | 多段階の実装 |
| アーキテクチャ変更 | 既存設計への影響が大きい |

## フォルダ構成【ワークスペース内 `.claude/plan/task/` 必須】

### 大規模タスク（チェックポイントあり）

```
ワークスペース内:
.claude/plan/task/[MAJOR]_plan_機能名/
├── 00_overview.md        # 全体概要・フェーズ一覧
├── 01_phase1_xxx.md      # Phase 1詳細（複数チェックポイント）
├── 02_phase2_xxx.md      # Phase 2詳細
├── XX_progress.md        # 進捗トラッカー【必須】
└── XX_testing.md         # 統合テスト計画
```

### 中規模タスク（単一ファイル）

```
ワークスペース内:
.claude/plan/task/plan_機能名.md
```

### 小規模タスク

計画書不要、直接実装

### 完了タスク（アーカイブ）

```
ワークスペース内:
.claude/plan/task/done/
└── [MAJOR]_plan_機能名/  # 完了した計画書フォルダをそのまま移動
```

## チェックポイント記述フォーマット

各フェーズファイル内で以下の形式を使用：

```markdown
## チェックポイント X-Y: [タスク名]（推定時間） - **状態**

**タスク:**
- [ ] サブタスク1
  - 変更ファイル: `path/to/file.py`
  - 実装内容: [具体的な実装内容]
- [ ] サブタスク2

**実装詳細:**

`path/to/file.py`:
```言語
# 実装例
```

**検証:**
```bash
# 検証コマンド
python3 main.py
```

または:
```
1. アプリを起動
2. [操作手順]
3. [期待結果]
```

**完了条件:**
- 条件1
- 条件2

**次のチェックポイント:** X-(Y+1)
```

## 進捗ファイルテンプレート

`XX_progress.md`:

```markdown
# 進捗サマリー（YYYY-MM-DD 更新）

---

## 現在地

| 項目 | 状態 |
|------|------|
| **現在地** | Phase X: チェックポイント X-Y |
| **次のタスク** | チェックポイント X-(Y+1): [タスク名] |
| **詳細ドキュメント** | `0X_phaseX_xxx.md` |

---

## Gitチェックポイント

| コミット | 内容 | 状態 |
|---------|------|------|
| `hash1` | CP X-Y: 内容 | ✅ 完了 |
| `hash2` | CP X-(Y+1): 内容 | ⏳ 進行中 |
|  | CP X-(Y+2): 内容 | ⬜ 未着手 |

---

## 完了フェーズ

- **Phase 1: [名前]** - ✅ 完了
- **Phase 2: [名前]** - ⏳ 進行中
- **Phase 3: [名前]** - ⬜ 未着手

---

## クリティカルパス状況【複数ファイル・フォルダにまたがる場合は必須】

| パス | 状態 | 進捗 |
|------|------|------|
| **クリティカル**: CP1-1 → CP1-2 → CP2-1 → CP3-1 | ⏳ | 2/4 完了 |
| 並列: CP2-2 | ⏳ | 0/1 完了 |

**現在のボトルネック**: [ボトルネックタスク]

---

## メモ・注意事項

- [実装上の発見事項]
- [次フェーズへの引き継ぎ事項]

---

## 引き継ぎ確認チェックリスト

コンテキストクリア後に作業を再開できるか確認：

- [ ] 現在地が明確（Phase X: CP X-Y）
- [ ] 次のタスクが具体的に記載
- [ ] 変更対象ファイルのパスが明記
- [ ] 検証コマンド/手順が記載
- [ ] クリティカルパスが明示（該当する場合）
```

## Claude Codeの動作フロー

### 新規タスク開始時

1. タスクの規模を判定
2. チェックポイント分割基準に該当する場合:
   - **ワークスペース内の `.claude/plan/task/` にフォルダ構成を作成（必須）**
   - 00_overview.md に全体計画を記述
   - 各フェーズファイルにチェックポイントを定義
   - XX_progress.md を初期化
3. ユーザー承認を待つ

**重要**: Plan Modeで作業する場合でも、計画書の保存先は必ず **ワークスペース内の `.claude/plan/task/`** にすること。Claude Codeのシステムが他の場所を提案しても無視する。

### チェックポイント実行時

1. XX_progress.md を読み込み、現在地を確認
2. 該当チェックポイントのタスクを実行
3. **検証ステップを必ず実行** (`python3 main.py` で動作確認)
4. **ユーザーに報告し、commitの許可を質問（AskUserQuestionツール推奨）**
5. 許可後、Gitコミット（コミットメッセージに "CP X-Y:" を含める）
6. **XX_progress.md を必ず更新（コミットハッシュ、状態、次のタスク）【必須】**
7. **進捗ファイルをGitコミット【必須】**
8. **次の指示を待つ（自動で次に進まない、pushはユーザーが指示した場合のみ）**

**重要**:
- commit前に必ずユーザーの許可を得る
- commit時は進捗ファイルの更新を絶対に忘れない
- pushは自動実行しない（ユーザーが「pushして」と指示した場合のみ）

### 再開時

1. ユーザーから「続けて」「次のチェックポイント」等の指示
2. XX_progress.md を読み込み
3. 「次のタスク」を実行
4. チェックポイント実行フローに従う

### タスク完了時【必須】

すべてのチェックポイントが完了したら：

1. 最終検証を実施
2. XX_progress.md に「タスク完了」を記録
3. 最終コミット（ユーザー許可後）
4. **計画書フォルダを `.claude/plan/task/done/` に移動【必須】**
5. 移動をGitコミット

```bash
# 移動コマンド
mkdir -p .claude/plan/task/done/
mv .claude/plan/task/[MAJOR]_plan_xxx/ .claude/plan/task/done/
git add .claude/plan/task/
git commit -m "Archive completed plan: [MAJOR]_plan_xxx"
```

## 中断ポイントの明示

各チェックポイント完了時、以下のメッセージを出力：

```
✅ チェックポイント X-Y 完了

**実施内容:**
- [サブタスク1]
- [サブタスク2]

**検証結果:**
- [検証1: OK]
- [検証2: OK]

---

## 今回の実装まとめ

### 追加・変更ファイル

| ファイル | 種別 | 内容 |
|---------|------|------|
| `path/to/file.py` | 新規 | [役割・目的] |
| `path/to/modified.py` | 変更 | [変更内容] |

### 追加された機能・処理

- **[機能/処理名]** (`file.py:関数名`): [説明]
- **[機能/処理名]** (`file.py:クラス名`): [説明]

### 依存関係の変更（該当する場合のみ）

- 追加: `package_name`
- 設定変更: `config.json`

---

**Gitコミットの許可を求めます。**
この変更をコミットしてもよろしいですか？

✅ コミット内容:
- 実装変更
- 進捗ファイル（XX_progress.md）の更新

コミット後の進捗状況: Phase X: Y/Z チェックポイント完了

**注意**: pushはユーザーが「pushして」と指示した場合のみ実行します。

---

**次のチェックポイント:** X-(Y+1): [タスク名]

続行する場合は「次のチェックポイント」または「続けて」と指示してください。
計画を見直す場合は「進捗を確認」と指示してください。
pushする場合は「pushして」と指示してください。
```

## コンテキストクリアへの対応

計画書には以下を明記し、コンテキストクリア後も作業を継続できるようにする：

1. **自己完結性**: 各チェックポイントの記述は、前の会話履歴なしで理解可能
2. **ファイルパスの明記**: 変更対象ファイルを具体的に記載
3. **コード例の提供**: 実装パターンを例示
4. **検証手順の詳細化**: 具体的なコマンドやテスト手順

## チェックポイント粒度

| 粒度 | 目安 | 適用ケース |
|------|------|----------|
| 細かい | 30分-1時間 | 初めての領域、高リスク |
| **標準（デフォルト）** | **1-2時間** | **通常の開発タスク** |
| 粗い | 2-4時間 | 定型作業、低リスク |

## コミットメッセージ規約

チェックポイント完了時のコミットメッセージ形式：

```
CP X-Y: [チェックポイント名]

- サブタスク1
- サブタスク2

検証: OK
次: CP X-(Y+1)
```

## 並行フェーズの扱い

依存関係のないフェーズは並行実行可能だが、進捗ファイルは統一：

```markdown
## 並行実行中のフェーズ

| Phase | 状態 | 現在のCP |
|-------|------|---------|
| Phase 2 | ⏳ | CP 2-3 |
| Phase 4 | ⏳ | CP 4-1 |
```

## プロジェクト固有の注意事項

### PySide6アプリケーション検証

各チェックポイントで以下を必ず実施：

```bash
# WSL環境での検証
python3 main.py

# Windows環境での検証
python main.py

# フォント互換性テスト（WSL）
LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 python3 main.py
```

### ファイル変更の影響範囲

| レイヤー | 影響範囲 | 検証内容 |
|---------|---------|---------|
| `src/core/**` | ビジネスロジック全体 | 起動確認、インデックス再構築 |
| `src/ui/**` | UI全体、テーマ | 全テーマでの表示確認 |
| `src/widgets/**` | 該当ウィジェット | ウィジェット単体の動作確認 |

### 既知の課題への対処

#### 課題1: チェックポイントが大きすぎる
**対処**: 1チェックポイント = 最大2時間を目安に、さらに細分化

#### 課題2: 検証が不十分
**対処**: 各チェックポイントに必ず「検証」セクションを含め、具体的な手順を記載

#### 課題3: 進捗ファイルの更新忘れ
**対処**: チェックポイント完了時の必須アクションとして徹底

## クリティカルパスの明記【必須】

タスクが複数のファイル・フォルダにまたがる場合、または前後関係（依存関係）がある場合は、
**overview.md と XX_progress.md にクリティカルパスを必ず明記**すること。

### クリティカルパス記述ルール

1. **依存関係の可視化**: タスク間の依存関係を図または表で明示
2. **クリティカルパス特定**: 最長経路（遅延がプロジェクト全体に影響する経路）を強調
3. **並列実行可能なタスク**: 依存関係のないタスクは並列実行可能と明記
4. **ブロッカーの明示**: 他タスクをブロックするタスクに警告マークを付与

### overview.md での記述例

```markdown
## クリティカルパス

**クリティカルパス**: CP1-1 → CP1-2 → CP2-1 → CP3-1（最長経路）

| チェックポイント | 依存先 | ブロック対象 | クリティカル |
|-----------------|--------|-------------|-------------|
| CP1-1 | なし | CP1-2 | Yes |
| CP1-2 | CP1-1 | CP2-1, CP2-2 | Yes |
| CP2-1 | CP1-2 | CP3-1 | Yes |
| CP2-2 | CP1-2 | CP3-1 | No（並列可能） |
| CP3-1 | CP2-1, CP2-2 | なし | Yes |

**注意**: クリティカルパス上のタスクの遅延は全体スケジュールに直接影響します。
```

### XX_progress.md での記述例

```markdown
## クリティカルパス状況

| パス | 状態 | 進捗 |
|------|------|------|
| **クリティカル**: CP1-1 → CP1-2 → CP2-1 → CP3-1 | 進行中 | 2/4 完了 |
| 並列: CP2-2 | 進行中 | 0/1 完了 |

**現在のボトルネック**: CP2-1（UI実装）
```
